
<html>
<header></header>
<body>
	<div id="createRole">
		<h3>Create new role</h3>
		<p>As an admin, you can create new roles with specific permissions to assign to new and existing users.</p>
		<p>
			<label for="roleNameInput">Role Name</label>
			<input type="text" id="roleNameInput" name="roleNameInput" placeholder="...">
		</p>
		<form>
			<div id="rolePermissionsInput">
			</div>
		</form>
	</div>
	<div id="existingRoles">
		<table>
			<tr>
				<th>Role</th>
				<th>Users</th>
				<th>Permissions</th>
			</tr>
			<tr>
				<td>(loading...)</td>
				<td>(loading...)</td>
				<td>(loading...)</td>
		</table>
	</div>
</body>
<script type="text/javascript" src="htmlTableFromRoles.js"></script>
<script>
	'use strict';

	function removeAllChildNodes(parent) {
	    while (parent.firstChild) {
	        parent.removeChild(parent.firstChild);
	    }
	}

	function repopulateFormCheckboxesWith(domNodes) {
		let domCheckboxes = document.getElementById("rolePermissionsInput")
		let excuses = document.createTextNode("Loading...")

		removeAllChildNodes(domCheckboxes)
		domNodes.forEach(x => domCheckboxes.appendChild(x))
	}

	function repopulateDomCheckboxesLoading() {
		let loadingElements = [document.createTextNode("Loading...")]
		repopulateFormCheckboxesWith(loadingElements)
	}

	function repopulateDomCheckboxesError(errorString) {
		errorString = errorString ?? "aw beans.  Something bad happened."
		let errorElements = [document.createTextNode(errorString)]
		repopulateFormCheckboxesWith(errorElements)
	}

	function createCheckboxHtmlElementsFromRoleName(name) {
		//Not whitespace friendly.
		let checkbox = document.createElement("input")
		let label = document.createElement("label")
		let description = document.createTextNode(name)

		checkbox.type = "checkbox"
		checkbox.id = "checkbox_" + name
		checkbox.name = "permission_" + name
		checkbox.value = "value_" + name

		label.htmlFor = "checkbox_" + name
		label.appendChild(description)

		return [checkbox, label]
	}

	function repopulateDomCheckboxesWithRoles(all_roles) {
		let arrayOfElements = all_roles.map(function(role) { 
			let elements = createCheckboxHtmlElementsFromRoleName(role.name) 
			elements = elements.concat([document.createElement("br")])
			return elements
		})

		repopulateFormCheckboxesWith(arrayOfElements.flat())
	}

	function changePermissionIdsIntoPermissionNames(idNumber, permissions) {
		let permission = permissions.find(y => y.id == idNumber)
		return permission?.name
	}

	function refreshPermissionsAndRoles() {
		let permissionsPromise = fetch("/permissions.json")
		.then( response => response.json() )
		.catch( err => repopulateDomCheckboxesError("aw beans: " + err.toString()) )

		let rolesPromise = fetch("/roles.json")
		.then( response => response.json() )
		.catch( err => console.log(err) )

		let populateInputOnPromise = Promise.allSettled([permissionsPromise])
		.then( results => repopulateDomCheckboxesWithRoles(results[0].value.data) )
		.catch( err => repopulateDomCheckboxesError("aw beans: " + err.toString()) )

		let populateTableOnPromise = Promise.allSettled([rolesPromise, permissionsPromise])
		.then(function(results) {
			let divTable = document.getElementById("existingRoles")
			removeAllChildNodes(divTable)
			divTable.appendChild(htmlTableFromRoles(results[0].value.data, results[1].value.data))
		})
		.catch( errors => console.log(errors) )
	}

	//Start doing actual things:
	repopulateDomCheckboxesLoading()
	refreshPermissionsAndRoles()

</script>
<footer></footer>
</html>